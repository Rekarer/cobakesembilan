<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Keterlambatan Murid Melalui Telegram</title>
    <!-- Load Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Pengaturan font dan latar belakang global */
        body {
            font-family: 'Inter', sans-serif;
            background-color: rgb(240, 253, 244); 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        button {
            transition: all 0.15s ease-in-out;
            transform: translateZ(0);
        }
    </style>
</head>
<body class="p-4">

    <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 md:p-8 space-y-6 border border-green-200 transform transition-all duration-300 hover:shadow-green-300/50">
        <h1 class="text-3xl font-extrabold text-green-700 text-center">Pencatat Keterlambatan Sekolah</h1>
        <p class="text-center text-sm text-gray-500">Ucapkan nama, alasannya, pilih kelas, dan kirim data.</p>

        <!-- Nama Murid Section -->
        <h2 class="text-xl font-bold text-green-700 pt-2">1. Nama Murid</h2>
        <div class="bg-green-50 border-2 border-green-300/50 rounded-xl p-4 space-y-3 shadow-inner">
            <div id="statusName" class="text-lg font-bold text-green-700">Status Nama: Belum dimulai</div>
            <div class="bg-white p-4 rounded-lg border border-gray-200 min-h-[4rem] whitespace-pre-wrap shadow-sm">
                <p class="text-gray-400 text-xs mb-1 font-semibold">Hasil Ucapan Nama Murid:</p>
                <p id="outputName" class="text-gray-800 text-base font-medium">Tekan tombol 'Ucapkan Nama Murid'.</p>
            </div>
            <div class="flex space-x-2">
                <button id="startNameBtn" class="flex-1 px-4 py-2 bg-green-600 text-white font-bold rounded-xl shadow-md shadow-green-400/50 hover:bg-green-700 disabled:opacity-50 disabled:shadow-none">
                    Ucapkan Nama
                </button>
                <button id="stopNameBtn" disabled class="px-4 py-2 bg-red-600 text-white font-bold rounded-xl shadow-md shadow-red-400/50 hover:bg-red-700 disabled:opacity-50 disabled:shadow-none w-1/3">
                    Stop
                </button>
            </div>
        </div>

        <!-- Alasan Keterlambatan Section -->
        <h2 class="text-xl font-bold text-blue-700 pt-4">2. Alasan Keterlambatan</h2>
        <div class="bg-blue-50 border-2 border-blue-300/50 rounded-xl p-4 space-y-3 shadow-inner">
            <div id="statusReason" class="text-lg font-bold text-blue-700">Status Alasan: Belum dimulai</div>
            <div class="bg-white p-4 rounded-lg border border-gray-200 min-h-[4rem] whitespace-pre-wrap shadow-sm">
                <p class="text-gray-400 text-xs mb-1 font-semibold">Hasil Ucapan Alasan Keterlambatan:</p>
                <p id="outputReason" class="text-gray-800 text-base font-medium">Tekan tombol 'Ucapkan Alasan Murid'.</p>
            </div>
            <div class="flex space-x-2">
                <button id="startReasonBtn" class="flex-1 px-4 py-2 bg-blue-600 text-white font-bold rounded-xl shadow-md shadow-blue-400/50 hover:bg-blue-700 disabled:opacity-50 disabled:shadow-none">
                    Ucapkan Alasan
                </button>
                <button id="stopReasonBtn" disabled class="px-4 py-2 bg-red-600 text-white font-bold rounded-xl shadow-md shadow-red-400/50 hover:bg-red-700 disabled:opacity-50 disabled:shadow-none w-1/3">
                    Stop
                </button>
            </div>
        </div>

        <!-- Class Dropdown -->
        <h2 class="text-xl font-bold text-purple-700 pt-4">3. Pilih Kelas</h2>
        <div>
            <label for="classDropdown" class="sr-only">Pilih Kelas Murid:</label>
            <select id="classDropdown" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-purple-500 focus:border-purple-500 shadow-sm text-gray-700">
                <option value="" disabled selected>--- Pilih Kelas ---</option>
                <option value="XI-A">XI-A</option>
                <option value="XI-B">XI-B</option>
                <option value="XI-C">XI-C</option>
                <option value="XI-D">XI-D</option>
                <option value="XI-E">XI-E</option>
                <option value="XI-F">XI-F</option>
                <option value="XI-G">XI-G</option>
                <option value="XI-H">XI-H</option>
                <option value="XI-I">XI-I</option>
            </select>
        </div>
        
        <!-- Status & Message -->
        <div class="bg-gray-100 border border-gray-300 rounded-xl p-4 space-y-2 shadow-inner">
            <div id="message" class="text-sm font-medium min-h-[1.25rem] text-center"></div>
        </div>

        <!-- Final Send Button -->
        <button id="sendBtn" disabled class="w-full px-6 py-3 bg-purple-600 text-white font-extrabold rounded-xl shadow-xl shadow-purple-400/50 hover:bg-purple-700 disabled:opacity-50 disabled:shadow-none">
            4. Kirim Data Keterlambatan
        </button>

    </div>

    <script type="text/javascript">
        // Global Constants and Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        // DOM References for Name
        const startNameBtn = document.getElementById("startNameBtn");
        const stopNameBtn = document.getElementById("stopNameBtn");
        const statusNameEl = document.getElementById("statusName");
        const outputNameEl = document.getElementById("outputName");

        // DOM References for Reason
        const startReasonBtn = document.getElementById("startReasonBtn");
        const stopReasonBtn = document.getElementById("stopReasonBtn");
        const statusReasonEl = document.getElementById("statusReason");
        const outputReasonEl = document.getElementById("outputReason");

        // General DOM References
        const sendBtn = document.getElementById("sendBtn");
        const messageEl = document.getElementById("message");
        const classDropdown = document.getElementById("classDropdown");

        // ***************************************************************
        // GANTI URL ini dengan URL Webhook Pabbly Connect Anda yang sebenarnya
        const PABBLY_WEBHOOK_URL = 'https://connect.pabbly.com/workflow/sendwebhookdata/IjU3NjYwNTY0MDYzZjA0M2Q1MjY4NTUzMDUxMzAi_pc'; 
        // ***************************************************************

        // Telegram Constants (opsional, untuk notifikasi)
        const TELEGRAM_TOKEN = "8094088254:AAHhx11hS3pBMyWrqjxKrd3oeRbA3joeB5c";
        const TELEGRAM_CHAT_ID = "1389280044";

        let rec;
        let lastTranscriptName = ""; // Variabel untuk Nama
        let lastTranscriptReason = ""; // Variabel untuk Alasan
        let currentRecordingTarget = null; // 'name' atau 'reason'

        // Fungsi untuk menampilkan pesan temporer di UI
        function showMessage(text, type = 'info') { // type: 'error', 'success', 'info'
            messageEl.textContent = text;
            messageEl.classList.remove('text-red-600', 'text-green-600', 'text-blue-600');
            if (type === 'error') messageEl.classList.add('text-red-600');
            else if (type === 'success') messageEl.classList.add('text-green-600');
            else messageEl.classList.add('text-blue-600');

            setTimeout(() => {
                messageEl.textContent = "";
            }, 5000);
        }

        // Fungsi untuk mengaktifkan/menonaktifkan tombol Kirim
        function checkSendButton() {
            const isReady = lastTranscriptName && lastTranscriptReason && classDropdown.value;
            sendBtn.disabled = !isReady;
        }

        if (!SpeechRecognition) {
            outputNameEl.textContent = "Browser Anda tidak mendukung Web Speech API.";
            showMessage("Browser Anda tidak mendukung Web Speech API.", 'error');
        } else {
            rec = new SpeechRecognition();
            rec.lang = "id-ID";
            rec.interimResults = false;
            rec.continuous = false; 

            rec.onstart = () => {
                // Update UI berdasarkan target rekaman saat ini
                if (currentRecordingTarget === 'name') {
                    statusNameEl.textContent = "Status Nama: ðŸŸ¢ Mendengarkan Nama...";
                    outputNameEl.textContent = "Sedang mendengarkan...";
                    startNameBtn.disabled = true;
                    stopNameBtn.disabled = false;
                    startReasonBtn.disabled = true;
                } else if (currentRecordingTarget === 'reason') {
                    statusReasonEl.textContent = "Status Alasan: ðŸŸ¢ Mendengarkan Alasan...";
                    outputReasonEl.textContent = "Sedang mendengarkan...";
                    startReasonBtn.disabled = true;
                    stopReasonBtn.disabled = false;
                    startNameBtn.disabled = true;
                }
                sendBtn.disabled = true;
                messageEl.textContent = "";
            };

            rec.onend = () => {
                // Update UI setelah rekaman berakhir
                if (currentRecordingTarget === 'name') {
                    statusNameEl.textContent = "Status Nama: ðŸŸ¡ Selesai. Siap rekam alasan.";
                    startNameBtn.disabled = false;
                    stopNameBtn.disabled = true;
                    startReasonBtn.disabled = false;
                } else if (currentRecordingTarget === 'reason') {
                    statusReasonEl.textContent = "Status Alasan: ðŸŸ¡ Selesai. Siap kirim.";
                    startReasonBtn.disabled = false;
                    stopReasonBtn.disabled = true;
                    startNameBtn.disabled = false;
                }
                currentRecordingTarget = null;
                checkSendButton();
            };

            rec.onerror = (event) => {
                console.error("Speech Recognition Error:", event.error);
                showMessage("Error pengenalan suara: " + event.error, 'error');
                
                // Reset UI state on error
                startNameBtn.disabled = false;
                stopNameBtn.disabled = true;
                startReasonBtn.disabled = false;
                stopReasonBtn.disabled = true;
                currentRecordingTarget = null;
                statusNameEl.textContent = "Status Nama: ðŸ”´ Error";
                statusReasonEl.textContent = "Status Alasan: ðŸ”´ Error";
                checkSendButton();
            }

            rec.onresult = (event) => {
                const result = event.results[event.results.length - 1];
                if (result.isFinal) {
                    const text = result[0].transcript;
                    
                    if (currentRecordingTarget === 'name') {
                        lastTranscriptName = text.trim().toUpperCase(); 
                        outputNameEl.textContent = lastTranscriptName;
                        statusNameEl.textContent = "Status Nama: âœ… Nama didapat.";
                        
                    } else if (currentRecordingTarget === 'reason') {
                        lastTranscriptReason = text.trim(); 
                        outputReasonEl.textContent = lastTranscriptReason;
                        statusReasonEl.textContent = "Status Alasan: âœ… Alasan didapat.";
                    }
                }
            };

            // --- Click Handlers ---

            // 1. Nama Murid Controls
            startNameBtn.onclick = () => {
                try { 
                    currentRecordingTarget = 'name';
                    rec.start(); 
                    lastTranscriptName = "";
                } catch (e) { 
                    console.error("Gagal memulai perekaman Nama:", e);
                    showMessage("Gagal memulai perekaman Nama. Mungkin sudah berjalan?", 'error');
                }
            };
            stopNameBtn.onclick = () => rec.stop();

            // 2. Alasan Keterlambatan Controls
            startReasonBtn.onclick = () => {
                try { 
                    currentRecordingTarget = 'reason';
                    rec.start(); 
                    lastTranscriptReason = "";
                } catch (e) { 
                    console.error("Gagal memulai perekaman Alasan:", e);
                    showMessage("Gagal memulai perekaman Alasan. Mungkin sudah berjalan?", 'error');
                }
            };
            stopReasonBtn.onclick = () => rec.stop();

            // Handle dropdown change to enable/disable send button
            classDropdown.onchange = checkSendButton;
        }

        // === FUNGSI KIRIM ===

        // Mengambil waktu dan tanggal saat ini
        function getCurrentDateTime() {
            const now = new Date();
            // Format waktu (e.g., 06:11:45)
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const time = now.toLocaleTimeString('id-ID', timeOptions); 
            
            // Format tanggal (e.g., 25/11/2025)
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const date = now.toLocaleDateString('id-ID', dateOptions); 
            
            return { time, date };
        }

        // FUNGSI UTAMA: Mengirim ke Webhook Pabbly
        sendBtn.onclick = () => {
            const selectedClass = classDropdown.value;
            
            if (!lastTranscriptName) {
                return showMessage("1. Belum ada Nama Murid yang diucapkan!", 'error');
            }
            if (!lastTranscriptReason) {
                return showMessage("2. Belum ada Alasan Keterlambatan yang diucapkan!", 'error');
            }
            if (!selectedClass) {
                return showMessage("3. Harap pilih Kelas Murid terlebih dahulu!", 'error');
            }
            
            sendBtn.disabled = true;
            showMessage("Mengirim data...", 'info');

            // Kirim ke Pabbly Webhook
            sendDataToPabblyWebhook(lastTranscriptName, selectedClass, lastTranscriptReason)
                .finally(() => {
                    sendBtn.disabled = false;
                });

            // Kirim ke Telegram (Opsional)
            sendToTelegram(`Pencatatan Keterlambatan:\nNama: ${lastTranscriptName}\nKelas: ${selectedClass}\nAlasan: ${lastTranscriptReason}`);
        };

        function sendToTelegram(text) {
            const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;

            fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    chat_id: TELEGRAM_CHAT_ID,
                    text: text
                })
            })
            .then(res => console.log("Telegram response:", res.status))
            .catch(err => console.error("Telegram upload failed:", err));
        }

        // --- Pabbly Webhook Sender ---
        async function sendDataToPabblyWebhook(name, studentClass, reason) {
            const dateTime = getCurrentDateTime();
            
            // =========================================================
            // FUNGSI UTAMA: MEMBUAT STRING TUNGGAL DENGAN PEMISAH |
            // Format yang dikirim: WAKTU|NAMA|KELAS|ALASAN|TANGGAL
            // =========================================================
            const rawDataString = `${dateTime.time}|${name}|${studentClass}|${reason}|${dateTime.date}`;
            
            // Kirim string tunggal ini dalam payload JSON
            const payload = { 
                raw_data: rawDataString, 
                nama_murid: name, // Tambahkan field terpisah untuk kemudahan debug di Pabbly
                kelas_murid: studentClass,
                alasan_keterlambatan: reason, // Field Alasan
                tanggal: dateTime.date,
                waktu: dateTime.time,
            };

            if (PABBLY_WEBHOOK_URL.includes('replace/me') || PABBLY_WEBHOOK_URL.includes('IjU3NjYwNTY0MDYzZjA0M2Q1MjY4NTUzMDUxMzAi_pc')) {
                console.error('ERROR: Ganti PABBLY_WEBHOOK_URL dengan URL Anda yang sebenarnya.');
                showMessage('GAGAL KIRIM: Harap ganti placeholder PABBLY_WEBHOOK_URL di kode!', 'error');
                return;
            }

            try {
                const response = await fetch(PABBLY_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Non-OK response from Pabbly: ${response.status} - ${errorText.substring(0, 100)}...`);
                }
                
                const result = await response.json();
                console.log('Data sukses dikirim ke Pabbly Connect!', payload, result);
                showMessage('Data Keterlambatan sukses dicatat! Siap untuk murid berikutnya.', 'success');
                
                // Reset untuk input berikutnya
                lastTranscriptName = "";
                lastTranscriptReason = "";
                outputNameEl.textContent = "Tekan tombol 'Ucapkan Nama Murid'.";
                outputReasonEl.textContent = "Tekan tombol 'Ucapkan Alasan Murid'.";
                statusNameEl.textContent = "Status Nama: Belum dimulai";
                statusReasonEl.textContent = "Status Alasan: Belum dimulai";
                classDropdown.value = ""; 
                checkSendButton();

            } catch (error) {
                console.error('Gagal mengirim data ke Pabbly Connect:', error);
                showMessage(`Gagal mengirim data: ${error.message}`, 'error');
            }
        }
    </script>
</body>

</html>